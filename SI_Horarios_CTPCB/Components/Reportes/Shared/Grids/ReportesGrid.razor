@using System.IO.Compression
@using QuestPDF.Fluent;
@using QuestPDF.Helpers;
@using QuestPDF.Infrastructure;
@using QuestPDF.Drawing;
@using System.Text.RegularExpressions
@using ClosedXML.Excel



<Div Class="main-content">
    <!-- Sección Izquierda: Formularios -->
    <Column ColumnSize="ColumnSize.Is12" Padding="Padding.Is3">
        <h3>Reportes</h3>
        <Row>
             <Column ColumnSize="ColumnSize.Is12.OnDesktop.Is12.OnMobile" Padding="Padding.Is3">
                <h5>Enviar Correos a todos los Profesores Activos con su Horario</h5>
            </Column>
        </Row>
        <Row>
            <Column ColumnSize="ColumnSize.Is6.OnDesktop.Is12.OnMobile" Padding="Padding.Is3">
                <Button Class="btn btn-base3" Clicked="@EnviarCorreos">Enviar Correos</Button>
            </Column>
        </Row>
        <Row>
            <Column ColumnSize="ColumnSize.Is12.OnDesktop.Is12.OnMobile" Padding="Padding.Is3">
                <h5>Descargar Reportes</h5>
            </Column>
        </Row>
        <Row>
            <Column ColumnSize="ColumnSize.Is1.OnDesktop.Is12.OnMobile" Padding="Padding.Is3">
                <Dropdown>
                    <DropdownToggle Class="btn-pdf">
                        PDF
                    </DropdownToggle>
                    <DropdownMenu>
                        <DropdownItem Clicked="@DownloadReportPDFSeccion">Horario por sección</DropdownItem>
                        <DropdownDivider />
                        <DropdownItem Clicked="@DownloadReportPDFProfesor">Horario por profesor</DropdownItem>
                    </DropdownMenu>
                </Dropdown>
            </Column>

            <Column ColumnSize="ColumnSize.Is1.OnDesktop.Is12.OnMobile" Padding="Padding.Is3">
                <Dropdown>
                    <DropdownToggle Class="btn-excel">
                        Excel
                    </DropdownToggle>
                    <DropdownMenu>
                        <DropdownItem Clicked="@DownloadReportExcelSeccion">Horario por sección</DropdownItem>
                        <DropdownDivider />
                        <DropdownItem Clicked="@DownloadReportExcelProfesor">Horario por profesor</DropdownItem>
                    </DropdownMenu>
                </Dropdown>
            </Column>
        </Row>

    </Column>
    <Column ColumnSize="ColumnSize.Is12.OnDesktop.Is12.OnMobile" Padding="Padding.Is3">
        <h3>Estadísticas</h3>
        <Row>
            <Column ColumnSize="ColumnSize.Is3.OnDesktop.Is12.OnMobile" Padding="Padding.Is3">
                <Button Class="btn btn-base3" Clicked="@HandleRedraw">Refrescar Gráfico</Button>
            </Column>
        </Row>
        <LoadingIndicator Visible="@loadingChart">
            <Div Class="mb-4">
                <BarChart @ref="barChart" TItem="double" Options="@options" />
            </Div>
        </LoadingIndicator>

    </Column>
    @* <Div Class="col-md-6 p-3">
                
            </Div> *@
</Div>

<ModalVerReporte @ref="modalReporte"></ModalVerReporte>
<SnackbarStack @ref="snackbarStack" Location="SnackbarStackLocation.Top" />
@code {
    SnackbarStack? snackbarStack;
    ModalVerReporte? modalReporte;
    private bool isLoading = false;
    private bool loadingChart = false;
    private List<string> listaCorreos = new();
    private string? NewEmail = "";
    

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await HandleRedraw();
        }
    }

    private async Task EnviarCorreos()
    {
        await Task.FromResult(MessageService.Info("Los correos se enviarán automáticamente a cada Profesor, se le indicará por notificaciones si ocurre algún error", "Reportes"));
        using var zipStream = new MemoryStream();
        using var archive = new ZipArchive(zipStream, ZipArchiveMode.Create, leaveOpen: true);

        var profesores = await api.Mantenimientos_GetAllProfesorAsync();
        var grupos = await api.Mantenimientos_GetAllGruposAsync();

        foreach (var profesor in profesores)
        {
            List<HorarioDto> horarioProfesor = new();

            // Recorrer grupos y recoger las clases donde el profesor aparezca
            foreach (var grupo in grupos)
            {
                var horarioGrupo = await api.Horarios_GetOneHorarioAsync(new HorarioDto { Id_Grupo = grupo.Id_Grupo });

                var clasesProfesor = horarioGrupo
                    .Where(x => x.Id_Profesor == profesor.Id_Profesor.ToString())
                    .ToList();

                horarioProfesor.AddRange(clasesProfesor);
            }

            // Si el profesor NO tiene clases, no crear PDF
            if (!horarioProfesor.Any())
                continue;
            // Cambia el nombre de la variable interna para evitar conflicto
            using var profesorZipStream = new MemoryStream();
            using (var profesorArchive = new ZipArchive(profesorZipStream, ZipArchiveMode.Create, leaveOpen: true))
            {
                var pdfBytes = await GenerarPdfHorarioProfesor(horarioProfesor, $"{profesor.Nombre} {profesor.Apellido}");
                var entryPdf = profesorArchive.CreateEntry($"{profesor.Cedula}_{profesor.Nombre}_{profesor.Apellido}_Horario.pdf");
                using (var entryStream = entryPdf.Open())
                {
                    entryStream.Write(pdfBytes, 0, pdfBytes.Length);
                }

                var excelBytes = await GenerarExcelHorarioProfesor(horarioProfesor, $"{profesor.Nombre} {profesor.Apellido}");
                var entryExcel = profesorArchive.CreateEntry($"{profesor.Nombre}_{profesor.Apellido}_Horario.xlsx");
                using (var entryStreamExcel = entryExcel.Open())
                {
                    entryStreamExcel.Write(excelBytes, 0, excelBytes.Length);
                }
            }

            var base64Zip = Convert.ToBase64String(profesorZipStream.ToArray());

            try
            {
                var res = await api.Mantenimientos_EnviarEmailAsync(new EnviarEmailDto
                {
                    Correo = profesor.Correo,
                    Base64file = base64Zip,
                    FileName = $"{profesor.Cedula}_{profesor.Nombre}_{profesor.Apellido}_Horario_ExcelPdf.zip",
                    Subject = $"Horarios en Excel y PDF Profesor {profesor.Cedula} {profesor.Nombre} {profesor.Apellido}"
                });

                if (string.IsNullOrEmpty(res.P_error))
                {
                    snackbarStack?.PushAsync($"Correo enviado para {profesor.Nombre} {profesor.Apellido} exitosamente", SnackbarColor.Info, options => { options.IntervalBeforeClose = 4000; });
                }
                else
                {
                    await Task.FromResult(MessageService.Info($"Ocurrió un error al enviar los correos: {res.P_error}", "Error"));
                }
            }
            catch (Exception ex)
            {
                await Task.FromResult(MessageService.Info($"Excepción al enviar correo a {profesor.Nombre} {profesor.Apellido}: {ex.Message}", "Error"));
            }

        }
    }

    #region Reportes PDF Seccion
    private async Task DownloadReportPDFSeccion()
    {
        try
        {

            await Task.FromResult(MessageService.Info("Reportes  generados exitosamente, pronto se descargaran!", "Reportes"));
            var zipBytes = await GenerarZipHorariosPDFseccion();
            var base64Zip = Convert.ToBase64String(zipBytes);
            var fileName = "HorariosGenerados.zip";

            await JS.InvokeVoidAsync("saveAsFile", fileName, base64Zip);

        }
        catch (Exception e)
        {
            await Task.FromResult(MessageService.Info($"Ocurrio un error a la hora de generar reportes\n\nMensaje:{e.Message}\nOrigen:{e.Source}", "Error Reportes "));
        }
    }

    private async Task<byte[]> GenerarZipHorariosPDFseccion()
    {
        using var zipStream = new MemoryStream();
        using var archive = new ZipArchive(zipStream, ZipArchiveMode.Create, leaveOpen: true);

        // Filtrar solo grupos activos
        var grupos = (await api.Mantenimientos_GetAllGruposAsync())
            .Where(grupo => grupo.Estado.Equals("A"))
            .ToList();

        foreach (var grupo in grupos)
        {
            var horarios = await api.Horarios_GetOneHorarioAsync(new HorarioDto { Id_Grupo = grupo.Id_Grupo });
            var pdfBytes = await GenerarPdfHorario(horarios.Where(x => x.Id_Grupo == grupo.Id_Grupo).ToList(), grupo.Nombre);

            var entry = archive.CreateEntry($"{grupo.Nombre}_Horario.pdf");
            using var entryStream = entry.Open();
            entryStream.Write(pdfBytes, 0, pdfBytes.Length);
        }

        archive.Dispose();
        return zipStream.ToArray();
    }

    private async Task<byte[]> GenerarPdfHorario(List<HorarioDto> horarios, string nombreGrupo)
    {
        QuestPDF.Settings.License = LicenseType.Community;
        var listaMaterias = await api.Mantenimientos_GetAllMateriasAsync();
        var listaProfesores = await api.Mantenimientos_GetAllProfesorAsync();
        var diasSemana = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes" };
        var diasSemanaCode = new[] { "L", "K", "M", "J", "V" };

        var pdf = QuestPDF.Fluent.Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4.Landscape());
                page.Margin(20);
                page.DefaultTextStyle(x => x.FontSize(10));

                page.Header().Text($"Horario - Grupo {nombreGrupo}").Bold().FontSize(16).AlignCenter();

                page.Content().Table(table =>
                {
                    table.ColumnsDefinition(columns =>
                    {
                        columns.ConstantColumn(100); // Hora
                        foreach (var _ in diasSemana)
                            columns.RelativeColumn();
                    });

                    // Header
                    table.Header(header =>
                    {
                        header.Cell().Text("Hora").Bold();
                        foreach (var dia in diasSemana)
                            header.Cell().Text(dia).Bold().AlignCenter();
                    });

                    foreach (var bloque in bloquesHorario)
                    {
                        table.Cell().Text($"{bloque.HoraInicio:hh\\:mm} - {bloque.HoraFin:hh\\:mm}");

                        foreach (var dia in diasSemanaCode)
                        {
                            if (bloque.EsReceso)
                            {
                                table.Cell().Background("#bbbec2").AlignCenter().AlignMiddle().Text("Receso");
                                continue;
                            }

                            var clase = horarios.FirstOrDefault(h =>
                                h.Dia.Equals(dia, StringComparison.OrdinalIgnoreCase)
                                && h.Hora_Inicio == bloque.HoraInicio
                                && h.Hora_Fin == bloque.HoraFin
                            );

                            if (clase != null)
                            {
                                var materia = listaMaterias.FirstOrDefault(m => m.Id_Materia == clase.Id_Materia);
                                var profesor = listaProfesores.FirstOrDefault(p => p.Id_Profesor.ToString() == clase.Id_Profesor);
                                var color = materia?.Color ?? "#6c757d";

                                table.Cell().Background(ApplyTransparency(color, 0.25)).Padding(5).Text(text =>
                                {
                                    text.DefaultTextStyle(x => x.FontSize(8));

                                    text.Span("Materia: ").SemiBold();
                                    text.Span($"{materia?.Nombre ?? "N/A"}\n");

                                    text.Span("Profesor: ").SemiBold();
                                    text.Span($"{profesor?.Nombre} {profesor?.Apellido}");
                                });
                            }
                            else
                            {
                                table.Cell().Background("#bbbec2").AlignCenter().AlignMiddle().Text("Sin asignar");
                            }
                        }
                    }
                });
            });
        });

        return pdf.GeneratePdf();
    }
    #endregion

    #region Reportes PDF Profesores
    private async Task DownloadReportPDFProfesor()
    {
        try
        {
            await Task.FromResult(MessageService.Info("Reportes  generados exitosamente, pronto se descargaran!", "Reportes"));

            var zipBytes = await GenerarZipHorariosPDFprofesor();
            var base64Zip = Convert.ToBase64String(zipBytes);
            var fileName = "HorariosPorProfesor.zip";

            await JS.InvokeVoidAsync("saveAsFile", fileName, base64Zip);
        }
        catch (Exception e)
        {
            await Task.FromResult(MessageService.Info(
                $"Ocurrió un error a la hora de generar reportes\n\nMensaje:{e.Message}\nOrigen:{e.Source}",
                "Error Reportes "));
        }
    }
    private async Task<byte[]> GenerarZipHorariosPDFprofesor()
    {
        using var zipStream = new MemoryStream();
        using var archive = new ZipArchive(zipStream, ZipArchiveMode.Create, leaveOpen: true);

        var profesores = await api.Mantenimientos_GetAllProfesorAsync();
        var grupos = await api.Mantenimientos_GetAllGruposAsync();

        foreach (var profesor in profesores)
        {
            List<HorarioDto> horarioProfesor = new();

            // Recorrer grupos y recoger las clases donde el profesor aparezca
            foreach (var grupo in grupos)
            {
                var horarioGrupo = await api.Horarios_GetOneHorarioAsync(new HorarioDto { Id_Grupo = grupo.Id_Grupo });

                var clasesProfesor = horarioGrupo
                    .Where(x => x.Id_Profesor == profesor.Id_Profesor.ToString())
                    .ToList();

                horarioProfesor.AddRange(clasesProfesor);
            }

            // Si el profesor NO tiene clases, no crear PDF
            if (!horarioProfesor.Any())
                continue;

            var pdfBytes = await GenerarPdfHorarioProfesor(horarioProfesor, $"{profesor.Nombre} {profesor.Apellido}");

            var entry = archive.CreateEntry($"{profesor.Cedula}_{profesor.Nombre}_{profesor.Apellido}_Horario.pdf");
            using var entryStream = entry.Open();
            entryStream.Write(pdfBytes, 0, pdfBytes.Length);
        }

        archive.Dispose();
        return zipStream.ToArray();
    }

    private async Task<byte[]> GenerarPdfHorarioProfesor(List<HorarioDto> horarios, string nombreProfesor)
    {
        QuestPDF.Settings.License = LicenseType.Community;
        var listaSeccion = await api.Mantenimientos_GetAllGruposAsync();
        var listaMaterias = await api.Mantenimientos_GetAllMateriasAsync();
        var listaProfesores = await api.Mantenimientos_GetAllProfesorAsync();
        var diasSemana = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes" };
        var diasSemanaCode = new[] { "L", "K", "M", "J", "V" };

        var pdf = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4.Landscape());
                page.Margin(20);
                page.DefaultTextStyle(x => x.FontSize(10));

                page.Header().Text($"Horario - Profesor {nombreProfesor}")
                    .Bold().FontSize(16).AlignCenter();

                page.Content().Table(table =>
                {
                    table.ColumnsDefinition(columns =>
                    {
                        columns.ConstantColumn(100);
                        foreach (var _ in diasSemana)
                            columns.RelativeColumn();
                    });

                    table.Header(header =>
                    {
                        header.Cell().Text("Hora").Bold();
                        foreach (var dia in diasSemana)
                            header.Cell().Text(dia).Bold().AlignCenter();
                    });

                    foreach (var bloque in bloquesHorario)
                    {
                        table.Cell().Text($"{bloque.HoraInicio:hh\\:mm} - {bloque.HoraFin:hh\\:mm}");

                        foreach (var dia in diasSemanaCode)
                        {
                            if (bloque.EsReceso)
                            {
                                table.Cell().Background("#bbbec2")
                                    .AlignCenter().AlignMiddle()
                                    .Text("Receso");
                                continue;
                            }

                            var clase = horarios.FirstOrDefault(h =>
                                h.Dia.Equals(dia, StringComparison.OrdinalIgnoreCase)
                                && h.Hora_Inicio == bloque.HoraInicio
                                && h.Hora_Fin == bloque.HoraFin
                            );

                            if (clase != null)
                            {
                                var materia = listaMaterias.FirstOrDefault(m => m.Id_Materia == clase.Id_Materia);
                                var seccion = listaSeccion.FirstOrDefault(m => m.Id_Grupo == clase.Id_Grupo);

                                var color = materia?.Color ?? "#6c757d";

                                table.Cell().Background(ApplyTransparency(color, 0.25))
                                .Padding(5).Text(txt =>
                                {
                                    txt.DefaultTextStyle(x => x.FontSize(8));

                                    txt.Span("Materia: ").SemiBold();
                                    txt.Span($"{materia?.Nombre ?? "N/A"}\n");
                                    txt.Span("Sección: ").SemiBold();
                                    txt.Span($"{seccion?.Nombre ?? "N/A"}\n");
                                });
                            }
                            else
                            {
                                table.Cell().Background("#bbbec2")
                                    .AlignCenter().AlignMiddle()
                                    .Text("Sin asignar");
                            }
                        }
                    }
                });
            });
        });

        return pdf.GeneratePdf();
    }
    #endregion

    #region Reportes Excel Seccion
    private async Task DownloadReportExcelSeccion()
    {
        try
        {
            await Task.FromResult(MessageService.Info("Reportes generados exitosamente, pronto se descargarán!", "Reportes"));
            var zipBytes = await GenerarZipHorariosExcelSeccion();
            var base64Zip = Convert.ToBase64String(zipBytes);
            var fileName = "HorariosGeneradosExcel.zip";
            await JS.InvokeVoidAsync("saveAsFile", fileName, base64Zip);
        }
        catch (Exception e)
        {
            await Task.FromResult(MessageService.Info($"Ocurrió un error al generar reportes\n\nMensaje:{e.Message}\nOrigen:{e.Source}", "Error Reportes"));
        }
    }

    private async Task<byte[]> GenerarZipHorariosExcelSeccion()
    {
        using var zipStream = new MemoryStream();
        using var archive = new ZipArchive(zipStream, ZipArchiveMode.Create, leaveOpen: true);

        // Filtrar solo grupos activos
        var grupos = (await api.Mantenimientos_GetAllGruposAsync())
            .Where(grupo => grupo.Estado.Equals("A"))
            .ToList();

        foreach (var grupo in grupos)
        {
            var horarios = await api.Horarios_GetOneHorarioAsync(new HorarioDto { Id_Grupo = grupo.Id_Grupo });
            var excelBytes = await GenerarExcelHorario(horarios.Where(x => x.Id_Grupo == grupo.Id_Grupo).ToList(), grupo.Nombre);

            var entry = archive.CreateEntry($"{grupo.Nombre}_Horario.xlsx");
            using var entryStream = entry.Open();
            entryStream.Write(excelBytes, 0, excelBytes.Length);
        }

        archive.Dispose();
        return zipStream.ToArray();
    }

    //Reportes Excel Profesores
    private async Task DownloadReportExcelProfesor()
    {
        try
        {
            await Task.FromResult(MessageService.Info("Reportes generados exitosamente, pronto se descargarán!", "Reportes"));
            var zipBytes = await GenerarZipHorariosExcelProfesor();
            var base64Zip = Convert.ToBase64String(zipBytes);
            var fileName = "HorariosPorProfesorExcel.zip";
            await JS.InvokeVoidAsync("saveAsFile", fileName, base64Zip);
        }
        catch (Exception e)
        {
            await Task.FromResult(MessageService.Info($"Ocurrió un error al generar reportes\n\nMensaje:{e.Message}\nOrigen:{e.Source}", "Error Reportes"));
        }
    }

    private async Task<byte[]> GenerarZipHorariosExcelProfesor()
    {
        using var zipStream = new MemoryStream();
        using var archive = new ZipArchive(zipStream, ZipArchiveMode.Create, leaveOpen: true);

        var profesores = await api.Mantenimientos_GetAllProfesorAsync();
        var grupos = await api.Mantenimientos_GetAllGruposAsync();

        foreach (var profesor in profesores)
        {
            List<HorarioDto> horarioProfesor = new();

            foreach (var grupo in grupos)
            {
                var horarioGrupo = await api.Horarios_GetOneHorarioAsync(new HorarioDto { Id_Grupo = grupo.Id_Grupo });
                var clasesProfesor = horarioGrupo
                    .Where(x => x.Id_Profesor == profesor.Id_Profesor.ToString())
                    .ToList();
                horarioProfesor.AddRange(clasesProfesor);
            }

            if (!horarioProfesor.Any())
                continue;

            var excelBytes = await GenerarExcelHorarioProfesor(horarioProfesor, $"{profesor.Nombre} {profesor.Apellido}");

            var entry = archive.CreateEntry($"{profesor.Nombre}_{profesor.Apellido}_Horario.xlsx");
            using var entryStream = entry.Open();
            entryStream.Write(excelBytes, 0, excelBytes.Length);
        }

        archive.Dispose();
        return zipStream.ToArray();
    }

    private async Task<byte[]> GenerarExcelHorario(List<HorarioDto> horarios, string nombreGrupo)
    {
        var listaMaterias = await api.Mantenimientos_GetAllMateriasAsync();
        var listaProfesores = await api.Mantenimientos_GetAllProfesorAsync();
        var diasSemana = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes" };
        var diasSemanaCode = new[] { "L", "K", "M", "J", "V" };

        using var workbook = new XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Horario");

        // Encabezados
        worksheet.Cell(1, 1).Value = $"Horario - Grupo {nombreGrupo}";
        worksheet.Range(1, 1, 1, diasSemana.Length + 1).Merge().Style.Font.SetBold().Font.FontSize = 16;
        worksheet.Row(1).Height = 20;

        worksheet.Cell(2, 1).Value = "Hora";
        for (int i = 0; i < diasSemana.Length; i++)
            worksheet.Cell(2, i + 2).Value = diasSemana[i];

        int row = 3;
        foreach (var bloque in bloquesHorario)
        {
            worksheet.Cell(row, 1).Value = $"{bloque.HoraInicio:hh\\:mm} - {bloque.HoraFin:hh\\:mm}";
            for (int col = 0; col < diasSemanaCode.Length; col++)
            {
                var dia = diasSemanaCode[col];
                if (bloque.EsReceso)
                {
                    worksheet.Cell(row, col + 2).Value = "Receso";
                    worksheet.Cell(row, col + 2).Style.Fill.BackgroundColor = XLColor.LightGray;
                    continue;
                }

                var clase = horarios.FirstOrDefault(h =>
                    h.Dia.Equals(dia, StringComparison.OrdinalIgnoreCase)
                    && h.Hora_Inicio == bloque.HoraInicio
                    && h.Hora_Fin == bloque.HoraFin
                );

                if (clase != null)
                {
                    var materia = listaMaterias.FirstOrDefault(m => m.Id_Materia == clase.Id_Materia);
                    var profesor = listaProfesores.FirstOrDefault(p => p.Id_Profesor.ToString() == clase.Id_Profesor);
                    var color = materia?.Color ?? "#FFFFFF";
                    var transparentColor = ApplyTransparencyEX(color, 0.25);



                    worksheet.Cell(row, col + 2).Value =
                       worksheet.Cell(row, col + 2).Value = $"Materia: {materia?.Nombre ?? "N/A"}{Environment.NewLine}Profesor: {profesor?.Nombre} {profesor?.Apellido}";
                    worksheet.Cell(row, col + 2).Style.Fill.BackgroundColor = transparentColor;

                    // Aplicar borde blanco de 2px
                    worksheet.Cell(row, col + 2).Style.Border.OutsideBorder = XLBorderStyleValues.Thick;
                    worksheet.Cell(row, col + 2).Style.Border.OutsideBorderColor = XLColor.White;


                }
                else
                {
                    worksheet.Cell(row, col + 2).Value = "Sin asignar";
                    worksheet.Cell(row, col + 2).Style.Fill.BackgroundColor = XLColor.FromHtml("#F2F2F2");
                }
            }
            row++;
        }

        worksheet.Columns().AdjustToContents();

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        return stream.ToArray();
    }
    #endregion

    #region Reportes Excel Horario Profesor
    private async Task<byte[]> GenerarExcelHorarioProfesor(List<HorarioDto> horarios, string nombreProfesor)
    {
        var listaSeccion = await api.Mantenimientos_GetAllGruposAsync();
        var listaMaterias = await api.Mantenimientos_GetAllMateriasAsync();
        var diasSemana = new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes" };
        var diasSemanaCode = new[] { "L", "K", "M", "J", "V" };

        using var workbook = new XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Horario");

        worksheet.Cell(1, 1).Value = $"Horario - Profesor {nombreProfesor}";
        worksheet.Range(1, 1, 1, diasSemana.Length + 1).Merge().Style.Font.SetBold().Font.FontSize = 16;
        worksheet.Row(1).Height = 20;

        worksheet.Cell(2, 1).Value = "Hora";
        for (int i = 0; i < diasSemana.Length; i++)
            worksheet.Cell(2, i + 2).Value = diasSemana[i];

        int row = 3;
        foreach (var bloque in bloquesHorario)
        {
            worksheet.Cell(row, 1).Value = $"{bloque.HoraInicio:hh\\:mm} - {bloque.HoraFin:hh\\:mm}";
            for (int col = 0; col < diasSemanaCode.Length; col++)
            {
                var dia = diasSemanaCode[col];
                if (bloque.EsReceso)
                {
                    worksheet.Cell(row, col + 2).Value = "Receso";
                    worksheet.Cell(row, col + 2).Style.Fill.BackgroundColor = XLColor.LightGray;
                    continue;
                }

                var clase = horarios.FirstOrDefault(h =>
                    h.Dia.Equals(dia, StringComparison.OrdinalIgnoreCase)
                    && h.Hora_Inicio == bloque.HoraInicio
                    && h.Hora_Fin == bloque.HoraFin
                );

                if (clase != null)
                {
                    var materia = listaMaterias.FirstOrDefault(m => m.Id_Materia == clase.Id_Materia);
                    var seccion = listaSeccion.FirstOrDefault(m => m.Id_Grupo == clase.Id_Grupo);
                    var color = materia?.Color ?? "#FFFFFF";
                    var transparentColor = ApplyTransparencyEX(color, 0.25);

                    worksheet.Cell(row, col + 2).Value =
                        worksheet.Cell(row, col + 2).Value = $"Materia: {materia?.Nombre ?? "N/A"}{Environment.NewLine}Sección: {seccion?.Nombre ?? "N/A"}";
                    worksheet.Cell(row, col + 2).Style.Fill.BackgroundColor = transparentColor;

                    worksheet.Cell(row, col + 2).Style.Border.OutsideBorder = XLBorderStyleValues.Thick;
                    worksheet.Cell(row, col + 2).Style.Border.OutsideBorderColor = XLColor.White;

                }
                else
                {
                    worksheet.Cell(row, col + 2).Value = "Sin asignar";
                    worksheet.Cell(row, col + 2).Style.Fill.BackgroundColor = XLColor.FromHtml("#F2F2F2");
                }
            }
            row++;
        }

        worksheet.Columns().AdjustToContents();

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        return stream.ToArray();
    }
    #endregion

    

    #region lista de Correos
    // private async Task QuitarCorreo(string correo)
    // {
    //     listaCorreos.Remove(correo);
    //     reportesModel.Correos = string.Join(",", listaCorreos);
    //     if (reportesModel != null)
    //         await api.Mantenimientos_AddUpdateReporteria_ProgamadaAsync(reportesModel);

    // }

    // private async Task HandleKeyPress(KeyboardEventArgs e)
    // {
    //     if (e.Key == "Enter" || e.Key == "Tab")
    //     {
    //         var email = NewEmail.Trim().TrimEnd(',');
    //         if (ValidateEmail(email))
    //         {
    //             if (!listaCorreos.Contains(email, StringComparer.OrdinalIgnoreCase))
    //             {
    //                 listaCorreos.Add(email);
    //                 reportesModel.Correos = string.Join(",", listaCorreos);
    //                 if (reportesModel != null)
    //                     await api.Mantenimientos_AddUpdateReporteria_ProgamadaAsync(reportesModel);
    //             }

    //             NewEmail = string.Empty;
    //         }
    //         else
    //         {
    //             await Task.FromResult(MessageService.Warning("Ingrese un correo válido (ejemplo@dominio.com)", "Reportes"));
    //         }
    //     }
    // }

    private bool ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return false;

        var pattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
        return Regex.IsMatch(email, pattern, RegexOptions.IgnoreCase);
    }
    #endregion

    #region Grafico

    async Task HandleRedraw()
    {
        loadingChart = true;
        await barChart.Clear();

        Labels.Clear();
        MateriaLabels.Clear();

        var niveles = await api.Mantenimientos_GetAllNivelAcademicoAsync();
        var grupos = await api.Mantenimientos_GetAllGruposAsync();

        Labels = niveles.Where(x => x.Estado.Equals("A")).Select(n => n.Nombre).ToList(); // Eje Y

        // Diccionario [nivel] => total lecciones
        Dictionary<string, double> datos = new();

        foreach (var nivel in Labels)
        {
            datos[nivel] = 0;
        }

        foreach (var grupo in grupos)
        {
            var nivel = niveles.FirstOrDefault(n => n.Id_Nivel_Academico == grupo.Id_Nivel_Academico)?.Nombre;
            if (nivel is null) continue;

            var horario = await api.Horarios_GenHorarioAsync(grupo.Id_Grupo);
            horario = horario.Where(x => x.Id_Grupo == grupo.Id_Grupo).ToList();

            // Sumar cantidad de bloques (lecciones) por grupo y nivel
            datos[nivel] += horario.Count;
        }

        var random = new Random();
        var backgroundColors = new List<string>();
        var borderColors = new List<string>();

        foreach (var _ in Labels)
        {
            byte r = (byte)random.Next(0, 255);
            byte g = (byte)random.Next(0, 255);
            byte b = (byte)random.Next(0, 255);

            backgroundColors.Add(ChartColor.FromRgba(r, g, b, 0.6f));
            borderColors.Add(ChartColor.FromRgba(r, g, b, 1f));
        }

        var dataset = new BarChartDataset<double>
        {
            Label = "Lecciones",
            Data = Labels.Select(nivel => datos[nivel]).ToList(),
            BackgroundColor = backgroundColors,
            BorderColor = borderColors,
            BorderWidth = 2
        };

        await barChart.AddLabelsDatasetsAndUpdate(Labels, new[] { dataset });
        loadingChart = false;
    }

    async Task HandleRedrawCantLeccionesMateriasxNivel()
    {
        loadingChart = true;
        await barChart.Clear();



        Labels.Clear();
        MateriaLabels.Clear();

        var niveles = await api.Mantenimientos_GetAllNivelAcademicoAsync();
        var materias = await api.Mantenimientos_GetAllMateriasAsync();
        var grupos = await api.Mantenimientos_GetAllGruposAsync();

        Labels = niveles.Where(x => x.Estado.Equals("A")).Select(n => n.Nombre).ToList(); // Eje Y
        MateriaLabels = materias.Where(x => x.Estado.Equals("A")).Select(m => m.Nombre).ToList();

        // Diccionario [nivel][materia] => total horas
        Dictionary<string, Dictionary<string, double>> datos = new();

        foreach (var nivel in Labels)
        {
            datos[nivel] = new Dictionary<string, double>();
            foreach (var materia in MateriaLabels)
                datos[nivel][materia] = 0;
        }

        //llenar datos
        foreach (var grupo in grupos)
        {
            var nivel = niveles.FirstOrDefault(n => n.Id_Nivel_Academico == grupo.Id_Nivel_Academico)?.Nombre;
            if (nivel is null) continue;

            var horario = await api.Horarios_GenHorarioAsync(grupo.Id_Grupo);
            horario = horario.Where(x => x.Id_Grupo == grupo.Id_Grupo).ToList();

            foreach (var clase in horario)
            {
                var materia = materias.FirstOrDefault(m => m.Id_Materia == clase.Id_Materia)?.Nombre;
                if (materia is null) continue;

                // Cada bloque equivale a 40 minutos
                var duracion = (clase.Hora_Fin - clase.Hora_Inicio).TotalMinutes / 40.0;
                datos[nivel][materia] += duracion;
            }
        }

        var random = new Random();
        List<BarChartDataset<double>> datasets = new();

        foreach (var materia in MateriaLabels)
        {
            var valores = Labels.Select(nivel => datos[nivel][materia]).ToList();

            // Generar color aleatorio por materia
            var r = (byte)random.Next(0, 255);
            var g = (byte)random.Next(0, 255);
            var b = (byte)random.Next(0, 255);

            var dataset = new BarChartDataset<double>
            {
                Label = materia,
                Data = valores,
                BackgroundColor = new List<string> { ChartColor.FromRgba(r, g, b, 0.6f) },
                BorderColor = new List<string> { ChartColor.FromRgba(r, g, b, 1f) },
                BorderWidth = 1
            };

            datasets.Add(dataset);
        }

        // Asignar etiquetas y datasets al gráfico
        await barChart.AddLabelsDatasetsAndUpdate(Labels, datasets.ToArray());
        loadingChart = false;
    }


    public class DetalleBloque
    {
        public string Materia { get; set; } = "";
        public string Profesor { get; set; } = "";
        public string Color { get; set; } = "#6c757d";
    }

    BarChart<double> barChart;

    BarChartOptions options = new()
    {
        IndexAxis = "y",
        Elements = new()
        {
            Bar = new()
            {
                BorderWidth = 2,
            }
        },
        Responsive = true,
        Plugins = new()
        {
            Legend = new()
            {
                Position = "right"
            },
            Title = new()
            {
                Display = true,
                Text = "Distribución de Lecciones por Nivel" // y Materia
            }
        }
    };

    List<string> Labels = new(); // ← Niveles
    List<string> MateriaLabels = new(); // ← Materias
    List<string> backgroundColors = new();
    List<string> borderColors = new();


    private List<BloqueHorario> bloquesHorario = new()
    {
        new(new(7, 0, 0), new(7, 40, 0)),
        new(new(7, 40, 0), new(8, 20, 0)),
        new(new(8, 20, 0), new(9, 0, 0)),
        new(new(9, 0, 0), new(9, 20, 0), true), // Receso
        new(new(9, 20, 0), new(10, 0, 0)),
        new(new(10, 0, 0), new(10, 40, 0)),
        new(new(10, 40, 0), new(11, 20, 0)),
        new(new(11, 20, 0), new(12, 0, 0), true), // Almuerzo
        new(new(12, 0, 0), new(12, 40, 0)),
        new(new(12, 40, 0), new(13, 20, 0)),
        new(new(13, 20, 0), new(14, 0, 0)),
        new(new(14, 0, 0), new(14, 20, 0), true), // Receso
        new(new(14, 20, 0), new(15, 0, 0)),
        new(new(15, 0, 0), new(15, 40, 0)),
        new(new(15, 40, 0), new(16, 20, 0))
    };

    public class BloqueHorario
    {
        public int IdHorario { get; set; }
        public TimeSpan HoraInicio { get; set; }
        public TimeSpan HoraFin { get; set; }
        public bool EsReceso { get; set; }
        public string RangoHorario { get; private set; }
        public Dictionary<string, DetalleBloque> DetallesPorDia { get; set; } = new();

        public BloqueHorario(TimeSpan horaInicio, TimeSpan horaFin, bool esReceso = false)
        {
            HoraInicio = horaInicio;
            HoraFin = horaFin;
            EsReceso = esReceso;
            RangoHorario = $"{DateTime.Today.Add(HoraInicio):hh\\:mm tt} - {DateTime.Today.Add(HoraFin):hh\\:mm tt}";
        }

        public DetalleBloque? GetDetalle(string dia)
        {
            DetallesPorDia.TryGetValue(dia, out var detalle);
            return detalle;
        }
    }


    string ApplyTransparency(string hexColor, double transparency = 0.25)
    {
        hexColor = hexColor.Replace("#", "");

        int r = Convert.ToInt32(hexColor.Substring(0, 2), 16);
        int g = Convert.ToInt32(hexColor.Substring(2, 2), 16);
        int b = Convert.ToInt32(hexColor.Substring(4, 2), 16);

        // Mezclamos el color con blanco (simula transparencia sobre fondo blanco)
        r = (int)(r + (255 - r) * (1 - transparency));
        g = (int)(g + (255 - g) * (1 - transparency));
        b = (int)(b + (255 - b) * (1 - transparency));

        return $"#{r:X2}{g:X2}{b:X2}";
    }

    #endregion
    private XLColor ApplyTransparencyEX(string hexColor, double transparency = 0.25)
    {
        hexColor = hexColor.Replace("#", "");

        int r = Convert.ToInt32(hexColor.Substring(0, 2), 16);
        int g = Convert.ToInt32(hexColor.Substring(2, 2), 16);
        int b = Convert.ToInt32(hexColor.Substring(4, 2), 16);

        // Mezclar el color con blanco (simula transparencia sobre fondo blanco)
        r = (int)(r + (255 - r) * (1 - transparency));
        g = (int)(g + (255 - g) * (1 - transparency));
        b = (int)(b + (255 - b) * (1 - transparency));

        return XLColor.FromArgb(r, g, b);
    }
}

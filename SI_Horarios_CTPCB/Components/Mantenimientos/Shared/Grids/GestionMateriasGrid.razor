@inject SIHAPI api
<Div Class="main-content">

    <LoadingIndicator Visible="@(data is null)">
        <ChildContent>
            <Row>
                <Column ColumnSize="ColumnSize.Is2.OnDesktop.Is12.OnMobile">
                    <Button Class="btn btn-plantilla" Margin="Margin.Is3.FromTop.Is3.FromTop" Clicked="@(async () => { await DescargarPlantillaMaterias(); snackbarStack?.PushAsync("Se estará descargando la plantilla en breves momentos", SnackbarColor.Info, options => { options.IntervalBeforeClose = 4000; }); })">Plantilla Excel Materias</Button>
                </Column>
                <Column ColumnSize="ColumnSize.Is2.OnDesktop.Is12.OnMobile">
                    <Button Class="btn btn-importar" Margin="Margin.Is3.FromTop.Is3.FromTop" Clicked="modalSubir!.Open">Importar Excel</Button>
                </Column>
            </Row>
            <br />
            <br />
            <Row>
                <ButtonsExportComponent T="MateriaDto" Data="data" Titulo="Materias" />

            </Row>

            <DataGrid UseInternalEditing="false" Hoverable @bind-SelectedRow="@selecteddata" CommandMode="DataGridCommandMode.ButtonRow" Editable Striped TItem="MateriaDto" Data="data" PageSize="10" PageSizes="[10, 20, 30]" ShowPageSizes
                      Responsive Filterable Sortable SortMode="DataGridSortMode.Multiple" EditMode="DataGridEditMode.Popup" ShowPager PopupTitleTemplate="SetModalTitle" PopupSize="ModalSize.Large"
                      UseValidation RowInserted="InsertNewItem" RowInserting="ValidateEditFields" RowUpdating="ValidateEditFields" RowUpdated="InsertNewItem" RowRemoving="RemovingRow" RowRemoved="DeleteItem">
                <DataGridColumns>
                    @* <DataGridColumn Field="@nameof(MateriaDto.Id_Materia)" Caption="Id" /> *@
                    <DataGridColumn Field="@nameof(MateriaDto.Nombre)" Editable Caption="Materia" />
                    <DataGridSelectColumn TItem="MateriaDto" Field="@nameof(MateriaDto.Tipo)" Caption="Tipo" Editable Data="@(EstadoHelper.listaTipoMateria)" ValueField="(x) => ((EstadoHelper.Estados)x).Value" TextField="(x) => ((EstadoHelper.Estados)x).Desc">
                        <DisplayTemplate>
                            @(context.Tipo.Equals("A") ? "Academica" : "Tecnica")
                        </DisplayTemplate>
                        <EditTemplate>
                            <Select SelectedValue="@((string)context.CellValue)" SelectedValueChanged="@(v => context.CellValue = v)" TValue="object" Style="min-width: 200px;">
                                <SelectItem Value="@("")">Seleccione una opción</SelectItem>
                                <SelectItem Value="@("A")">Académica</SelectItem>
                                <SelectItem Value="@("T")">Técnica</SelectItem>
                            </Select>
                        </EditTemplate>

                    </DataGridSelectColumn>
                    <DataGridColumn Field="@nameof(MateriaDto.Color)" Editable Caption="Color" Sortable=false Filterable=false>
                        <DisplayTemplate >
                            <Div style="display: flex; align-items: center; gap: 10px; ">
                                <ColorEdit Color="@context.Color" Style="width: 100%; height:70px;" Disabled />
                               
                            </Div>
                        </DisplayTemplate>
                        <EditTemplate>
                            <ColorPicker Color="@((string)context.CellValue)"
                                         ColorChanged="@(v => context.CellValue = v)"
                                         Style="min-width: 200px;" />

                        </EditTemplate>
                    </DataGridColumn>
                    <DataGridSelectColumn TItem="MateriaDto" Field="@nameof(MateriaDto.Estado)" Caption="Estado" Editable Data="@(EstadoHelper.listaActivoInactivo)" ValueField="(x) => ((EstadoHelper.Estados)x).Value" TextField="(x) => ((EstadoHelper.Estados)x).Desc">
                        <DisplayTemplate>
                            @(context.Estado.Equals("A") ? "Activo" : "Inactivo")
                        </DisplayTemplate>
                        <EditTemplate>
                            <Select SelectedValue="@((string)context.CellValue)" SelectedValueChanged="@(v => context.CellValue = v)" TValue="object" Style="min-width: 200px;">
                                <SelectItem Value="@("")">Seleccione una opción</SelectItem>
                                <SelectItem Value="@("A")">Activo</SelectItem>
                                <SelectItem Value="@("I")">Inactivo</SelectItem>
                            </Select>
                        </EditTemplate>

                    </DataGridSelectColumn>

                </DataGridColumns>
                <ButtonRowTemplate>
                    <Button Class="btn btn-create" Clicked="context.NewCommand.Clicked">Nuevo</Button>
                    <Button Class="btn btn-edit" Disabled="(selecteddata is null)" Clicked="context.EditCommand.Clicked">Editar</Button>
                    <Button Class="btn btn-inactivar" Disabled="(selecteddata is null)" Clicked="context.DeleteCommand.Clicked">Inactivar</Button>
                </ButtonRowTemplate>
                <NextPageButtonTemplate><Icon Name="IconName.AngleRight" /></NextPageButtonTemplate>
                <PreviousPageButtonTemplate><Icon Name="IconName.AngleLeft" /></PreviousPageButtonTemplate>
                <LastPageButtonTemplate><Icon Name="IconName.AngleRight" /><Icon Name="IconName.AngleRight" /></LastPageButtonTemplate>
                <FirstPageButtonTemplate><Icon Name="IconName.AngleLeft" /><Icon Name="IconName.AngleLeft" /></FirstPageButtonTemplate>
            </DataGrid>


        </ChildContent>
    </LoadingIndicator>
</Div>
<ModalSubirArchivoMaterias OnInsert="CallbackInsertarExcel" @ref="modalSubir"></ModalSubirArchivoMaterias>
<ModalSubirArchivoMaterias @ref="modalSubir"></ModalSubirArchivoMaterias>
<SnackbarStack @ref="snackbarStack" Location="SnackbarStackLocation.Top" />

@code {


    private string accessCategory { get; set; } = "";
    SnackbarStack? snackbarStack;


    IEnumerable<MateriaDto>? data { get; set; } = new List<MateriaDto>();

    private MateriaDto? selecteddata;

    ModalSubirArchivoMaterias? modalSubir;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender)
        {
            data = await api.Mantenimientos_GetAllMateriasAsync();

            StateHasChanged();
        }
    }

    RenderFragment SetModalTitle(PopupTitleContext<MateriaDto> context)
    {
        var title = context.EditState == DataGridEditState.New ? "Nueva" : "Editar";
        return (__builder) =>
        {
            <Span>
                @($"{title} Materias")
            </Span>
        };
    }

    async Task InsertNewItem(SavedRowItem<MateriaDto, Dictionary<string, object>> item)
    {
        try
        {


            var errors = item.NewItem.ValidateObjectFields();
            if (!string.IsNullOrEmpty(errors))
            {
                await Task.FromResult(MessageService.Info(errors, "Datos requeridos faltantes"));
            }
            else
            {
                //asignar un color forzado antes de agregarlo
                //item.NewItem.Color = Random()
                await api.Mantenimientos_AddUpdateMateriasAsync(item.NewItem);
                data = await api.Mantenimientos_GetAllMateriasAsync();
            }
        }
        catch (Exception ex)
        {

        }
    }

    Task ValidateEditFields(CancellableRowChange<MateriaDto, Dictionary<string, object>> item)
    {

        var errors = item.NewItem.ValidateObjectFields();
        if (!string.IsNullOrEmpty(errors))
        {
            item.Cancel = true;
            return MessageService.Info(errors, "Datos requeridos faltantes");
        }
        else
        {
            return Task.CompletedTask;
        }
    }

    async Task DeleteItem(MateriaDto item)
    {
        await api.Mantenimientos_DeleteMateriasAsync(item);
        data = await api.Mantenimientos_GetAllMateriasAsync();
        //data = data.Where(x => x.Id_Materia != item.Id_Materia);
    }

    async Task RemovingRow(CancellableRowChange<MateriaDto> item)
    {
        var delete = await MessageService.Confirm($"Está seguro de inactivar la Materia {item.OldItem.Nombre}?", "Eliminar Materia", opt =>
        {
            // opt.MessageIcon = Icon
        });
        if (!delete)
        {
            item.Cancel = true;
        }
    }

    private async Task DescargarPlantillaMaterias()
    {
        try
        {
            
            using (var libro = new XLWorkbook())
            {
                IXLWorksheet hoja = libro.Worksheets.Add("Resumen (Masivo)");

                hoja.Columns().Width = 30;
                hoja.Cell(1, 1).Value = "Nombre";
                hoja.Cell(1, 2).Value = "Tipo (A/T)";


                for (int col = 1; col <= 2; col++)
                {
                    var celda = hoja.Cell(1, col);
                    celda.Style.Font.Bold = true;
                    celda.Style.Font.FontSize = 14;
                    celda.Style.Fill.BackgroundColor = XLColor.FromHtml("#C6EFCE");
                }

                using (var memoria = new MemoryStream())
                {
                    libro.SaveAs(memoria);
                    var nombreExcel = string.Concat("Plantilla Materias", ".xlsx");

                    await JS.InvokeAsync<object>(
                        "saveAsFile",
                        nombreExcel,
                        Convert.ToBase64String(memoria.ToArray())
                    );
                }
            }
        }
        catch (Exception ex)
        {
        }
    }

    async Task CallbackInsertarExcel()
    {
        data = await api.Mantenimientos_GetAllMateriasAsync();
        StateHasChanged();
        await Task.FromResult(MessageService.Success("Archivo de materias subido correctamente, refresque la pantalla", "Archivo Procesado Correctamente"));
    }
}
